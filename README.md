# RAID Monitor для Proxmox VE

Скрипт для автоматического мониторинга состояния RAID контроллера LSI и отправки уведомлений по email при обнаружении проблем.

## Основано на проверенном решении

Данный скрипт основан на хорошо отлаженном решении от [calomel.org](https://calomel.org/megacli_lsi_commands.html) и адаптирован для современных LSI MegaRAID контроллеров с использованием утилиты `storcli` вместо устаревшей `MegaCLI`.

**Оригинальный скрипт:** [calomel.org lsi.sh](https://calomel.org/megacli_lsi_commands.html)  
**Автор оригинального решения:** Calomel.org team  
**Адаптация и улучшения:** Anton-Sevnet

## Описание

Этот скрипт предназначен для работы на серверах Proxmox VE с установленными RAID контроллерами LSI. Он автоматически проверяет состояние контроллера, виртуальных и физических дисков, кэша и других компонентов, отправляя уведомления администратору при обнаружении проблем.

## Что проверяет скрипт

### Основные проверки:
- **Общее состояние контроллера** - работоспособность RAID контроллера
- **CacheVault (конденсатор)** - состояние и температура системы кэширования
- **Виртуальные диски** - состояние RAID массивов
- **Физические диски** - состояние жестких дисков и их SMART статус
- **Ошибки дисков** - счетчики ошибок чтения/записи на физических дисках
- **Кэш контроллера** - состояние системы кэширования
- **Фоновые задачи** - процессы инициализации и проверки консистентности

### Расширенные проверки (на основе calomel.org):
- **Умный мониторинг BBU/CacheVault** - автоматическое определение типа компонента (батарея или конденсатор)
- **Детальная диагностика ошибок** - анализ SMART атрибутов и счетчиков ошибок
- **Мониторинг фоновых операций** - проверка прогресса rebuild и patrol read
- **Анализ логов контроллера** - парсинг событий и аварийных сигналов
- **Предсказательные отказы** - раннее обнаружение проблемных дисков

## Уведомления

Скрипт отправляет уведомления **только по email**:
- При обнаружении критических проблем отправляется подробное письмо администратору
- В режиме DEBUG отправляются уведомления даже при нормальном состоянии для тестирования

## Требования

- Proxmox VE 9.0+
- Установленная утилита `storcli` для управления RAID контроллером
- Установленная утилита `swaks` для отправки email
- Настроенные уведомления в PVE (target "mail") или отдельный конфигурационный файл

## Установка

### 1. Установка необходимых утилит

```bash
# Установка swaks для отправки email
apt update
apt install swaks
```

### 2. Создание скрипта

Скопируйте содержимое скрипта `raid_monitor.sh` в файл `/root/raid_monitor.sh`:

```bash
# Сделать скрипт исполняемым
chmod +x /root/raid_monitor.sh
```

### 3. Настройка конфигурации (опционально)

По умолчанию скрипт использует настройки email из PVE. Если вы хотите использовать отдельные настройки, создайте файл `/root/raid_notification.conf`:

```bash
# Пример конфигурационного файла
cat > /root/raid_notification.conf << 'EOF'
SMTP_SERVER="smtp.mail.ru"
SMTP_PORT="587"
SMTP_USER="your-email@mail.ru"
SMTP_PASS="your-app-password"
FROM_EMAIL="your-email@mail.ru"
TO_EMAIL="admin@yourdomain.com"

# Дополнительные получатели (через запятую)
# Пример: ADDITIONAL_RECIPIENTS="admin2@domain.com,admin3@domain.com"
ADDITIONAL_RECIPIENTS=""
EOF
```

**Важно:** Используйте пароль приложения, а не основной пароль от почтового ящика!

### Настройки для различных почтовых провайдеров

#### Yandex (рекомендуется)
```bash
SMTP_SERVER="smtp.yandex.ru"
SMTP_PORT="587"
SMTP_USER="your-email@yandex.ru"
SMTP_PASS="your-app-password"  # Пароль приложения из настроек безопасности
FROM_EMAIL="your-email@yandex.ru"
```

**Особенности Yandex:**
- ✅ Порт 587 с STARTTLS (автоматически определяется скриптом)
- ✅ Порт 465 с SSL/TLS (альтернативный вариант)
- ✅ Требуется пароль приложения (настройте в разделе "Безопасность")
- ✅ Поддержка двухфакторной аутентификации

#### Mail.ru
```bash
SMTP_SERVER="smtp.mail.ru"
SMTP_PORT="587"
SMTP_USER="your-email@mail.ru"
SMTP_PASS="your-app-password"
FROM_EMAIL="your-email@mail.ru"
```

#### Gmail
```bash
SMTP_SERVER="smtp.gmail.com"
SMTP_PORT="587"
SMTP_USER="your-email@gmail.com"
SMTP_PASS="your-app-password"  # Пароль приложения
FROM_EMAIL="your-email@gmail.com"
```

### Дополнительные получатели

Скрипт поддерживает отправку уведомлений на несколько email адресов:

#### 1. Из PVE Notification Target
Скрипт автоматически читает дополнительные получатели из поля "Additional Recipient(s)" в PVE notification target 'mail'.

#### 2. Из конфигурационного файла
Альтернативно, можно указать дополнительные получатели в файле `/root/raid_notification.conf`:

```bash
# Основной получатель
TO_EMAIL="admin@yourdomain.com"

# Дополнительные получатели (через запятую)
ADDITIONAL_RECIPIENTS="admin2@domain.com,admin3@domain.com,monitoring@domain.com"
```

#### Приоритет источников:
1. **PVE Notification Target** - если доступен, используется в первую очередь
2. **Конфигурационный файл** - используется как fallback или дополнение
3. **Автоматическое объединение** - скрипт объединяет получателей из обоих источников
4. **Удаление дубликатов** - автоматически убирает повторяющиеся адреса

## Настройка автоматического запуска

### Добавление в cron

Для автоматического запуска каждые 5 минут добавьте задачу в crontab:

```bash
# Открыть crontab для редактирования (от root)
sudo crontab -e

# Добавить одну из следующих строк:

# Вариант 1: Без логирования (рекомендуется)
*/5 * * * * /usr/scripts/raid_monitor.sh >/dev/null 2>&1

# Вариант 2: С логированием в файл
*/5 * * * * /usr/scripts/raid_monitor.sh >> /var/log/raid_monitor_cron.log 2>&1
```

### Объяснение параметров crontab:

- `*/5 * * * *` - каждые 5 минут
- `>/dev/null 2>&1` - перенаправляет весь вывод в /dev/null (без логирования)
- `>> /var/log/raid_monitor_cron.log 2>&1` - записывает вывод в лог-файл

### Проверка работы crontab:

```bash
# Просмотр текущих задач crontab
sudo crontab -l

# Проверка логов cron (если используется логирование)
tail -f /var/log/raid_monitor_cron.log

# Проверка системных логов cron
tail -f /var/log/syslog | grep CRON
```

### Альтернативные интервалы

- Каждую минуту: `* * * * * /usr/scripts/raid_monitor.sh >/dev/null 2>&1`
- Каждые 10 минут: `*/10 * * * * /usr/scripts/raid_monitor.sh >/dev/null 2>&1`
- Каждый час: `0 * * * * /usr/scripts/raid_monitor.sh >/dev/null 2>&1`
- Каждые 6 часов: `0 */6 * * * /usr/scripts/raid_monitor.sh >/dev/null 2>&1`

## Тестирование

### Ручной запуск

```bash
# Запуск скрипта вручную
/root/raid_monitor.sh
```

### Режим DEBUG

Для тестирования отправки уведомлений даже при нормальном состоянии:

```bash
# Запуск в режиме DEBUG
/root/raid_monitor.sh debug
```

В режиме DEBUG скрипт:
- Отправляет уведомления даже при нормальном состоянии RAID
- Выводит подробную информацию о процессе проверки
- Показывает все команды storcli, которые выполняются

## Настройка email

### Использование настроек PVE

Скрипт автоматически использует настройки из PVE, если:
- В PVE настроен target "mail" в разделе Notifications
- Указаны корректные настройки SMTP сервера
- Настроен получатель по умолчанию

### Создание пароля приложения для mail.ru

1. Войдите в настройки почтового ящика mail.ru
2. Перейдите в раздел "Безопасность"
3. Найдите "Пароли для внешних приложений"
4. Создайте новый пароль для приложения
5. Используйте этот пароль в конфигурации

## Устранение неполадок

### Проблемы с отправкой email

1. **Проверьте настройки SMTP:**
   ```bash
   # Проверить настройки PVE
   cat /etc/pve/notifications.cfg
   ```

2. **Тестирование отправки email:**
   ```bash
   # Тест с помощью swaks
   swaks --to your-email@domain.com \
         --from your-email@mail.ru \
         --server smtp.mail.ru \
         --port 587 \
         --auth LOGIN \
         --auth-user your-email@mail.ru \
         --auth-password 'your-app-password' \
         --tls \
         --header "Subject: Тест" \
         --body "Тестовое сообщение"
   ```

### Проблемы с storcli

1. **Проверьте доступность storcli:**
   ```bash
   which storcli
   storcli /c0 show
   ```

2. **Проверьте права доступа:**
   ```bash
   # Убедитесь, что скрипт запускается от root
   whoami
   ```

### Проблемы с cron

1. **Проверьте статус cron:**
   ```bash
   systemctl status cron
   ```

2. **Проверьте логи cron:**
   ```bash
   tail -f /var/log/syslog | grep CRON
   ```

## Структура файлов

```
/root/
├── raid_monitor.sh              # Основной скрипт
├── raid_notification.conf       # Конфигурация email (опционально)
├── raid_notification.conf.example # Пример конфигурации
└── raid_monitor_state.conf      # Файл состояния ошибок (создается автоматически)
```

## Безопасность

- Скрипт должен запускаться от пользователя root
- Конфигурационный файл с паролями имеет права доступа 600
- Пароли не выводятся в логи
- Используйте пароли приложений, а не основные пароли

## Поддерживаемые RAID контроллеры

Скрипт протестирован с:
- LSI MegaRAID контроллеры
- Утилита storcli версии 007.3405.0000.0000+

## Логирование

Скрипт **не ведет локальные логи**. Вся информация о работе выводится в консоль при запуске.

### Отслеживание состояния ошибок

Скрипт создает файл `/usr/scripts/raid_monitor_state.conf` для отслеживания состояния ошибок:

```bash
# Состояние ошибок RAID контроллера
LAST_ERRORS_HASH="abc123..."          # MD5 хеш списка ошибок
LAST_ERRORS_COUNT="3"                 # Количество ошибок
LAST_ERRORS_TIME="1704067200"         # Время последней проверки
LAST_NOTIFICATION_TIME="1704067200"   # Время последнего уведомления
LAST_ERRORS_LIST="..."                # Список ошибок для детального анализа
```

**Расположение файла состояния:**
- **Полный путь:** `/usr/scripts/raid_monitor_state.conf`
- **Содержимое:** MD5 хеш ошибок, количество ошибок, временные метки, список ошибок
- **Назначение:** Предотвращение спама уведомлений при неизменном состоянии ошибок

Этот файл используется для:
- Сравнения текущего состояния с предыдущим
- Отправки уведомлений только при изменении состояния
- Контроля частоты уведомлений (не чаще 1 раза в 24 часа)
- Детального анализа изменений в ошибках

### Режим DEBUG

При запуске с параметром `debug` скрипт выводит подробную информацию:
- Все выполняемые команды storcli
- Результаты каждой проверки
- Статус отправки email уведомлений

## Примеры уведомлений

### Нормальная работа
```
2025-01-15 18:00:01: Запуск проверки RAID контроллера
Проверяем состояние RAID контроллера... ✓
2025-01-15 18:00:05: Проверка завершена
```

### Обнаружена проблема
```
2025-01-15 18:05:01: Запуск проверки RAID контроллера
Проверяем состояние RAID контроллера... ✓
Отправляем письмо...
  Тема: ВНИМАНИЕ: Проблемы с RAID контроллером на your-server
  Получатель: admin@example.com
Письмо отправлено успешно
2025-01-15 18:05:10: Проверка завершена
```

### Полное восстановление
```
2025-01-15 20:10:01: Запуск проверки RAID контроллера
Проверяем состояние RAID контроллера... ✓
Ошибки устранены в течение 24 часов: отправляем уведомление о восстановлении
Отправляем письмо...
  Тема: ПОЛНОЕ ВОССТАНОВЛЕНИЕ: RAID контроллер на your-server - ERROR 0, WARNING 0
  Получатель: admin@example.com
Письмо отправлено успешно
2025-01-15 20:10:15: Проверка завершена
```

### Частичное восстановление
```
2025-01-15 20:15:01: Запуск проверки RAID контроллера
Проверяем состояние RAID контроллера... ✓
Ошибки устранены в течение 24 часов: отправляем уведомление о восстановлении
Отправляем письмо...
  Тема: ЧАСТИЧНОЕ ВОССТАНОВЛЕНИЕ: RAID контроллер на your-server - ERROR 0, WARNING 1
  Получатель: admin@example.com
Письмо отправлено успешно
2025-01-15 20:15:20: Проверка завершена
```

### Режим DEBUG
```
2025-01-15 18:10:01: Запуск проверки RAID контроллера
Режим DEBUG включен - будут отправляться уведомления даже при нормальном состоянии
Проверяем состояние RAID контроллера...
  → Проверяем общее состояние контроллера... (storcli /c0 show)
  → Проверяем состояние CacheVault... (storcli /c0 /cv show)
  → Проверяем состояние виртуальных дисков... (storcli /c0 /vall show)
  → Проверяем состояние физических дисков... (storcli /c0 /eall /sall show)
  → Проверяем физические диски на ошибки... (storcli /c0/eX/sY show smart, storcli /c0/eX/sY show phyerrorcounters)
    → Проверяем диск 32:0...
    → Проверяем диск 32:1...
  → Проверяем состояние кэша... (storcli /c0 show cache)
  → Проверяем фоновые задачи... (storcli /c0 show bgi)
Отправляем письмо...
  Тема: DEBUG: RAID контроллер в норме на your-server
  Получатель: admin@example.com
Письмо отправлено успешно
2025-01-15 18:10:15: Проверка завершена
```

## Изменения в версии

### v2.1 (текущая версия)
- **Добавлено отслеживание состояния ошибок** - скрипт сохраняет состояние в файл `/root/raid_monitor_state.conf`
- **Умные уведомления** - отправка уведомлений только при изменении состояния или раз в 24 часа
- **Детальные уведомления о восстановлении** - показывают какие проблемы устранены и сколько осталось
- **Контроль частоты** - предотвращение спама повторяющихся уведомлений
- **Исправлено обнаружение проблем** - исправлены регулярные выражения для корректного обнаружения деградированных RAID массивов
- **Улучшен парсинг вывода storcli** - используется более надежный метод извлечения данных из секций "Virtual Drives" и "PD LIST"
- **Исправлены синтаксические ошибки** - исправлены проблемы с отступами и структурой if/fi блоков
- **Исправлена логика времени** - исправлена проблема с неправильным подсчетом времени между уведомлениями
- **Добавлен расширенный отладочный вывод** - для диагностики обнаружения проблем RAID
- **Исправлены регулярные выражения** - добавлены сокращенные состояния RAID (Dgrd, Pdgd) для корректного определения критичности

### v2.0
- **Удален функционал создания задач в PVE Tasks** - скрипт больше не создает записи в журнале задач Proxmox
- **Удалено логирование в файл** - скрипт не ведет локальные логи, вся информация выводится в консоль
- **Удалена проверка событий контроллера** - исключена проверка `storcli /c0 show events`
- **Упрощена архитектура** - скрипт теперь работает исключительно как email-монитор RAID

### v1.0 (предыдущая версия)
- Полный функционал с созданием задач в PVE
- Логирование в `/var/log/raid_monitor.log`
- Проверка событий контроллера

## Поддержка

При возникновении проблем:
1. Запустите скрипт в режиме DEBUG для диагностики
2. Убедитесь в корректности настроек email
3. Проверьте доступность storcli
4. Убедитесь в правильности настроек cron

## Лицензия

Скрипт предоставляется "как есть" для использования в административных целях.