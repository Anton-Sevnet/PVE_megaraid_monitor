# Инструкция по использованию RAID Monitor v2.1

## Новый функционал: Умные уведомления

### Как это работает

Скрипт теперь отслеживает состояние ошибок RAID контроллера и отправляет уведомления только в следующих случаях:

1. **При изменении состояния** - когда появляются новые ошибки или исчезают старые
2. **При восстановлении** - когда проблемы устранены в течение 24 часов после их обнаружения
3. **Повторные уведомления** - раз в 24 часа для постоянных проблем
4. **Режим DEBUG** - всегда отправляет уведомления для тестирования

**Важно:** Уведомления о восстановлении отправляются только если:
1. Проблема была обнаружена в течение последних 24 часов
2. **И** есть реально устраненные проблемы (не пустой список)

Если проблема была давно (более 24 часов назад) или нет реально устраненных проблем, уведомление о восстановлении не отправляется.

### Типы уведомлений о восстановлении:

1. **ПОЛНОЕ ВОССТАНОВЛЕНИЕ** - все проблемы устранены (ERROR 0, WARNING 0)
2. **ЧАСТИЧНОЕ ВОССТАНОВЛЕНИЕ** - устранены некоторые проблемы, но остались другие
3. **Детальная информация** - показывается какие именно проблемы устранены и сколько осталось

### Файл состояния

Скрипт создает файл `/root/raid_monitor_state.conf` с информацией о состоянии:

```bash
# Состояние ошибок RAID контроллера
LAST_ERRORS_HASH="68b329da9893e34099c7d8ad5cb9c940"  # MD5 хеш ошибок
LAST_ERRORS_COUNT="0"                                 # Количество ошибок
LAST_ERRORS_TIME="1704067200"                         # Время проверки
LAST_NOTIFICATION_TIME="0"                           # Время уведомления
```

### Примеры работы

#### Сценарий 1: Первый запуск (ошибок нет)
```
Сохранено состояние ошибок: 68b329da9893e34099c7d8ad5cb9c940
Ошибок нет: не отправляем уведомление
```

#### Сценарий 2: Обнаружены ошибки
```
Сохранено состояние ошибок: a1b2c3d4e5f6...
Состояние ошибок изменилось: отправляем уведомление
Отправляем письмо...
  Тема: ВНИМАНИЕ: Проблемы с RAID контроллером на your-server
```

#### Сценарий 3: Полное восстановление (все ошибки устранены)
```
Сохранено состояние ошибок: 68b329da9893e34099c7d8ad5cb9c940
Ошибки устранены в течение 24 часов: отправляем уведомление о восстановлении
Отправляем письмо...
  Тема: ПОЛНОЕ ВОССТАНОВЛЕНИЕ: RAID контроллер на your-server - ERROR 0, WARNING 0
```

#### Сценарий 3.1: Частичное восстановление (остались предупреждения)
```
Сохранено состояние ошибок: a1b2c3d4e5f6...
Ошибки устранены в течение 24 часов: отправляем уведомление о восстановлении
Отправляем письмо...
  Тема: ЧАСТИЧНОЕ ВОССТАНОВЛЕНИЕ: RAID контроллер на your-server - ERROR 0, WARNING 2
```

#### Сценарий 3.2: Частичное восстановление (остались критические ошибки)
```
Сохранено состояние ошибок: b2c3d4e5f6a1...
Ошибки устранены в течение 24 часов: отправляем уведомление о восстановлении
Отправляем письмо...
  Тема: ЧАСТИЧНОЕ ВОССТАНОВЛЕНИЕ: RAID контроллер на your-server - ERROR 1, WARNING 0
```

#### Сценарий 4: Ошибки были давно (более 24 часов назад)
```
Сохранено состояние ошибок: 68b329da9893e34099c7d8ad5cb9c940
Ошибки были давно (более 24 часов назад): не отправляем уведомление о восстановлении
```

#### Сценарий 4.1: Нет реально устраненных проблем
```
Сохранено состояние ошибок: 68b329da9893e34099c7d8ad5cb9c940
Нет реально устраненных проблем: пропускаем уведомление о восстановлении
```

#### Сценарий 4.2: Режим DEBUG (всегда отправляет уведомления)
```
Сохранено состояние ошибок: 68b329da9893e34099c7d8ad5cb9c940
DEBUG режим: отправляем уведомление
Отправляем письмо...
  Тема: ПОЛНОЕ ВОССТАНОВЛЕНИЕ: RAID контроллер на your-server - ERROR 0, WARNING 0
  Получатель: admin@example.com
Письмо отправлено успешно
```

#### Сценарий 5: Те же ошибки, прошло 24 часа
```
Сохранено состояние ошибок: a1b2c3d4e5f6...
Прошло 24 часа с последнего уведомления: отправляем повторное
```

#### Сценарий 6: Те же ошибки, прошло менее 24 часов
```
Сохранено состояние ошибок: a1b2c3d4e5f6...
Состояние не изменилось и прошло менее 24 часов: пропускаем уведомление
```

### Режим DEBUG

При запуске с параметром `debug` скрипт всегда отправляет уведомления:

```bash
bash /root/raid_monitor.sh debug
```

Вывод:
```
DEBUG режим: отправляем уведомление
```

### Управление файлом состояния

#### Просмотр текущего состояния
```bash
cat /root/raid_monitor_state.conf
```

#### Сброс состояния (принудительная отправка уведомления)
```bash
rm /root/raid_monitor_state.conf
```

#### Ручное изменение времени последнего уведомления
```bash
# Установить время 24 часа назад (принудительная отправка)
sed -i 's/LAST_NOTIFICATION_TIME="[0-9]*"/LAST_NOTIFICATION_TIME="0"/' /root/raid_monitor_state.conf
```

### Настройка cron

Рекомендуемый интервал запуска - каждые 5 минут:

```bash
*/5 * * * * /root/raid_monitor.sh
```

При таком интервале:
- Уведомления отправляются сразу при обнаружении проблем
- Повторные уведомления приходят раз в 24 часа
- Нет спама при постоянных проблемах

### Мониторинг работы

#### Проверка последнего запуска
```bash
# Посмотреть время последней проверки
grep "LAST_ERRORS_TIME" /root/raid_monitor_state.conf
```

#### Проверка последнего уведомления
```bash
# Посмотреть время последнего уведомления
grep "LAST_NOTIFICATION_TIME" /root/raid_monitor_state.conf
```

#### Конвертация Unix timestamp в читаемый формат
```bash
# Пример: 1704067200 -> 2024-01-01 00:00:00
date -d @1704067200
```

### Устранение неполадок

#### Проблема: Уведомления не отправляются
1. Проверьте файл состояния: `cat /root/raid_monitor_state.conf`
2. Проверьте настройки email
3. Запустите в режиме DEBUG: `bash /root/raid_monitor.sh debug`

#### Проблема: Слишком много уведомлений
1. Проверьте интервал cron (не должен быть слишком частым)
2. Убедитесь, что файл состояния не удаляется между запусками

#### Проблема: Уведомления не приходят о восстановлении
1. Удалите файл состояния: `rm /root/raid_monitor_state.conf`
2. Запустите скрипт вручную
3. Проверьте, что ошибки действительно устранены
