# Умный мониторинг BBU/CacheVault

## Проблема

В LSI MegaRAID контроллерах может быть установлен либо **BBU (Battery Backup Unit)** - батарея, либо **CacheVault** - конденсатор, но не оба одновременно. Старая версия скрипта не учитывала эту особенность и могла выдавать ложные предупреждения.

## Решение

Реализована умная логика мониторинга, которая:

### ✅ **Автоматически определяет тип компонента**
- Проверяет наличие `Cachevault_Info` или `BBU_Info` в выводе `storcli /c0 /cv show`
- Определяет, какой именно компонент установлен в контроллере

### ✅ **Правильно обрабатывает отсутствие компонента**
- Если нет ни BBU, ни CacheVault - это **НЕ ошибка**
- Скрипт просто пропускает проверку и продолжает работу

### ✅ **Специфичные проверки для каждого типа**

#### **Для BBU (батарея):**
- ✅ Состояние батареи (Optimal/Not Optimal)
- ✅ Уровень заряда (предупреждение при < 80%)
- ✅ Состояние зарядки
- ❌ Температура (у BBU обычно нет датчика температуры)

#### **Для CacheVault (конденсатор):**
- ✅ Состояние конденсатора (Optimal/Not Optimal)
- ✅ Температура (предупреждение при > 50°C)
- ❌ Заряд (у конденсатора нет заряда)

### ✅ **Общие проверки для обоих типов**
- ✅ Состояние кэша
- ✅ Общее состояние компонента

## Примеры работы

### Сценарий 1: Контроллер с BBU
```bash
# Вывод storcli /c0 /cv show содержит:
BBU_Info:
  State: Optimal
  Charge: 95%
  Charging: Yes

# Результат: ✅ Все в порядке
```

### Сценарий 2: Контроллер с CacheVault
```bash
# Вывод storcli /c0 /cv show содержит:
Cachevault_Info:
  State: Optimal
  Temperature: 35C

# Результат: ✅ Все в порядке
```

### Сценарий 3: Контроллер без BBU/CacheVault
```bash
# Вывод storcli /c0 /cv show не содержит BBU_Info или Cachevault_Info

# Результат: ✅ Нет ошибок (компонент просто отсутствует)
```

### Сценарий 4: Проблема с BBU
```bash
# Вывод storcli /c0 /cv show содержит:
BBU_Info:
  State: Failed
  Charge: 15%
  Charging: No

# Результат: ❌ Найдены проблемы:
# → BBU в состоянии: Failed
# → BBU низкий заряд: 15%
```

### Сценарий 5: Проблема с CacheVault
```bash
# Вывод storcli /c0 /cv show содержит:
Cachevault_Info:
  State: Degraded
  Temperature: 65C

# Результат: ❌ Найдены проблемы:
# → CacheVault в состоянии: Degraded
# → CacheVault высокая температура: 65C
```

## Преимущества

### ✅ **Точность диагностики**
- Нет ложных срабатываний при отсутствии компонента
- Правильная интерпретация состояния каждого типа

### ✅ **Гибкость**
- Работает с любыми типами контроллеров LSI
- Автоматическая адаптация к конфигурации

### ✅ **Информативность**
- Четкие сообщения о типе обнаруженного компонента
- Специфичные предупреждения для каждого типа

## Код

Улучшенная функция находится в:
- `raid_monitor.sh` (строки 390-430)
- `raid_monitor_enhanced.sh` (функция `check_bbu_status()`)

## Тестирование

Для тестирования используйте режим DEBUG:
```bash
./raid_monitor.sh debug
```

В режиме DEBUG вы увидите детальную информацию о том, какой компонент обнаружен и какие проверки выполняются.
